<!DOCTYPE html>
<html>
<head>
    <title>Anon Messenger</title>
    <style>
        body { font-family: Arial; background: #f5f5f5; margin:0; padding:0; }
        #header { background:#111; color:white; padding:12px; text-align:center; }
        #chat { padding:10px; max-width:600px; margin: auto; }
        #messages { background:white; height:400px; overflow-y:auto; padding:10px; border:1px solid #ddd; }
        input { width:100%; padding:10px; margin-top:6px; }
        button { padding:10px; width:100%; background:#111; color:white; margin-top:6px; cursor:pointer; }
        .msg { margin-bottom:8px; }
        .user { font-weight:bold; }
        .time { color:gray; font-size:0.8em; margin-left:5px; }
    </style>
</head>
<body>
    <div id="header">Anon Messenger</div>
    <div id="chat">
        <input id="username" placeholder="Type your name (or leave blank for anonymous)">
        <div id="messages"></div>
        <input id="msgInput" placeholder="Type a message">
        <button onclick="sendMessage()">Send</button>
    </div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const messagesDiv = document.getElementById("messages");
const usernameInput = document.getElementById("username");
const msgInput = document.getElementById("msgInput");

// --- Load localStorage messages
let localMessages = JSON.parse(localStorage.getItem('messages')) || [];
localMessages.forEach(m => displayMessage(m));

// --- Send message
function sendMessage(){
    const user = usernameInput.value.trim() || "Anonymous";
    const msg = msgInput.value.trim();
    if(!msg) return;

    // Send to server
    socket.emit("sendMessage", { user, message: msg }, (ack) => {
        if(ack.allowed){
            const messageObj = { user, message: msg, time: new Date().toLocaleTimeString() };
            displayMessage(messageObj);
            saveLocalMessage(messageObj);
        } else {
            alert("Message blocked: " + ack.reason);
        }
    });
    msgInput.value = "";
}

// --- Display message
function displayMessage(m){
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<span class="user">${m.user}</span><span class="time">${m.time}</span>: ${m.message}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// --- Save locally
function saveLocalMessage(m){
    localMessages.push(m);
    localStorage.setItem('messages', JSON.stringify(localMessages));
}

// --- Listen for others' messages
socket.on("newMessage", (m) => {
    displayMessage(m);
});
</script>
</body>
</html>